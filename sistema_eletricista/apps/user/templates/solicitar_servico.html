{% load staticfiles %}

<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Eletricista24hs</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="{% static 'radiant/jquery/vendors/iconfonts/mdi/css/materialdesignicons.min.css' %}">
  <link rel="stylesheet" href="{% static 'radiant/jquery/vendors/iconfonts/puse-icons-feather/feather.css' %}">
  <link rel="stylesheet" href="{% static 'radiant/jquery/vendors/css/vendor.bundle.base.css' %}">
  <link rel="stylesheet" href="{% static 'radiant/jquery/vendors/css/vendor.bundle.addons.css' %}">
  <!-- endinject -->
  <!-- plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" href="{% static 'radiant/jquery/css/style.css' %}">
  <link rel="stylesheet" href="{% static 'radiant/jquery/css/adaptacoes.css' %}">
  <!-- endinject -->
  <link rel="shortcut icon" href="{% static 'radiant/jquery/images/logo-personagem.png' %}" />
</head>

<body class="horizontal-menu-2">
  <div class="container-scroller">
    <!-- Horizontal Menu Start -->
    <nav class="navbar horizontal-layout-2 col-lg-12 col-12 p-0 align-items-start">
      <div class="container">
        <div class="text-center navbar-brand-wrapper d-flex align-items-top justify-content-center" style="width:50%">
          <a class="navbar-brand brand-logo" style="width:50%; position: relative; left: -15%;" href="../../index.html"><img style="height:100%; width:150%" class="logo-escrita" src="{% static 'radiant/jquery/images/sf-escrita.png' %}" alt="logo"/></a>
          <a class="navbar-brand brand-logo" style="z-index: 100%; width: 20%; position: relative; left: -22.5%; top:10%; margin-left:1%" href="../../index.html"><img style="height:50%; width:auto" class="logo-personagem" src="{% static 'radiant/jquery/images/sf-personagem.png' %}" alt="logo"/></a>
          <a class="navbar-brand brand-logo-mini" href="../../index.html"><img src="{% static 'radiant/jquery/images/sf-personagem.png' %}" alt="logo"/></a>
        </div>

        <div class="navbar-menu-wrapper d-flex align-items-center pr-0" style="width:50%">
          <ul class="navbar-nav ml-auto dropdown-menus">
            <li class="nav-item dropdown">
              <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-toggle="dropdown">
                <i class="mdi mdi-bell-outline"></i>
                <span class="count bg-success">4</span>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
                <a class="dropdown-item py-3">
                  <p class="mb-0 font-weight-medium float-left">You have 4 new notifications
                  </p>
                  <span class="badge badge-pill badge-inverse-info float-right">View all</span>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-inverse-success">
                      <i class="mdi mdi-alert-circle-outline mx-0"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <h6 class="preview-subject font-weight-normal text-dark mb-1">Application Error</h6>
                    <p class="font-weight-light small-text mb-0">
                      Just now
                    </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-inverse-warning">
                      <i class="mdi mdi-comment-text-outline mx-0"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <h6 class="preview-subject font-weight-normal text-dark mb-1">Settings</h6>
                    <p class="font-weight-light small-text mb-0">
                      Private message
                    </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-inverse-info">
                      <i class="mdi mdi-email-outline mx-0"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <h6 class="preview-subject font-weight-normal text-dark mb-1">New user registration</h6>
                    <p class="font-weight-light small-text mb-0">
                      2 days ago
                    </p>
                  </div>
                </a>
              </div>
            </li>
            <li class="nav-item mr-0">
              <a href="#" class="nav-link py-0 pr-0">
                <span class="text-black d-none d-lg-inline-block text-white mr-2">Hello, Sebastian !</span>
                <img class="img-xs rounded-circle" src="https://placehold.it/100x100" alt="profile image">
              </a>
            </li>
          </ul>
          <button type="button" class="navbar-toggler d-block d-md-none"><i class="mdi mdi-menu"></i></button>
        </div>
      </div>
      <div class="container">
        <div class="nav-bottom">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link count-indicator" href="{% url 'cliente' %}">
                Solicitar serviço
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link count-indicator" href="">
                Editar perfil
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link count-indicator" href="">
                Histórico de serviços
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link count-indicator" href="">
                Pagamento
              </a>
            </li>
            
          </ul>
          <ul class="navbar-nav ml-auto d-none d-lg-block">
            <li class="nav-item mr-4">
              <form action="#">
                <div class="form-group mb-0">
                  <div class="input-group search-field">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="mdi mdi-magnify"></i></span>
                    </div>
                    <input type="text" class="form-control" placeholder="Search">
                  </div>
                </div>
              </form>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Horizontal Menu Ends -->
    <div class="container-fluid page-body-wrapper">
      <div class="main-panel">
        <div class="content-wrapper mt-0 p-0" >
          <div class="container mx-0 p-0 wid">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <div id="map"></div>
  <!--<input type="text" name="enderecoA" placeholder="Digite o local da partida" style="margin: 15px" id="A" class="form-control">
  <input type="text" name="enderecoB" placeholder="Digite o local de destino" style="margin: 15px; float: center; margin-left: 15px" id="B" class="form-control">
  <button id="botao" class="btn btn-success" style="margin-left: 46%">Enviar</button>-->
  <h4 id="local_a" class="info" >Local A: </h4>
  <h4 id="local_b" class="info" >Local B: </h4>
  <h4 id="t" class="info" >Tempo de chegada: </h4>
  <h4 id="d" class="info" >Distancia total: </h4>
  <div class="fundo-botao">
    <button id="solicitar" class="btn btn-warning" >Soliciar Serviço</button>
  </div>
  <script>
    //geocoding transforma adress em latlng
    alert('Temos 1 cliente na minha casa(Rua Cubatao) e 5 eletricistas(Na faria lima, na poli, na paulista, num extra do lado de casa e num sesc da vila mariana) todos estáticos, depois é só trocar essas dados com dados reais(latitude e longitude, armazenados no db)')
    var distancia = []
    var tempo = []
    var eletricistas = []
    var end_cliente
    var end_elec
    var map
    var dirdisplay
    var dirservice
    var eu
    var botao = document.getElementById('botao')
    //botao.addEventListener('click', () => {
      //var partida = document.getElementById('A').value
      //ar destino = document.getElementById('B').value
      //jsonRequest(partida, destino, map)
      //distanciaETempoDaRota(partida, destino)
      //setaRotaDoFormulario(partida, destino)
    //})
    var solicitar_servico = document.getElementById('solicitar')
    solicitar_servico.addEventListener('click', () => {
      mostrarMapaCompletoComMenorDistanciaEntreClienteEEletricista()
    })
    function initMap() {
      var options = {
        zoom: 15,
        center: {lat:-23.5782479, lng:-46.6425898}
      }

      map = new google.maps.Map(document.getElementById('map'), options);
      addMarker(options.center, map, "{% static 'radiant/jquery/images/red_MarkerC.png' %}");

      eu = new google.maps.LatLng(-23.5782479, -46.6425898) //cliente em questao(no caso eu, rola)
      eletricistas[0] = new google.maps.LatLng(-23.5773671, -46.6868916) //faria lima
      eletricistas[1] = new google.maps.LatLng(-23.5631043, -46.6543825) //av paulista
      eletricistas[2] = new google.maps.LatLng(-23.5571644, -46.730234) //poli
      eletricistas[3] = new google.maps.LatLng(-23.5822135, -46.6441941) //sesc vila mariana
      eletricistas[4] = new google.maps.LatLng(-23.5799952, -46.6403997) //extra vila mariana
      eletricistas[5] = new google.maps.LatLng(-23.5793521, -46.641414) //local mais próximo de todos do cliente
      for (var x = 0; x < eletricistas.length; x++){
        addMarker(eletricistas[x], map, "{% static 'radiant/jquery/images/yellow_MarkerE.png' %}")
      }

      dirdisplay = new google.maps.DirectionsRenderer();
      dirservice = new google.maps.DirectionsService();
  
    }

    function addMarker(position, map, icon) {
      var marker = new google.maps.Marker({position : position, map : map, icon : icon});
    }
    
    function calculateRoute(dir, dis, ori, dest) {
      //origins=-23.5782479,-46.6425898&destinations=-23.6229423,-46.6360948
      apagaMapa(dis)

      var request = {
        //origin: new google.maps.LatLng(-23.5782479, -46.6425898),
        origin: ori,
        //destination: new google.maps.LatLng(-23.6229423, -46.630948),
        destination: dest,
        travelMode:'DRIVING',
      };
      //var dir = new google.maps.DirectionsService();
      dir.route(request, function(response, status) {
        console.log(status);
        if(status == 'OK'){
          //var dis = new google.maps.DirectionsRenderer();
          console.log(response);
          dis.setDirections(response);
        }
      });
    }


    
    function jsonRequest(partida, destino, mapa) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {

          var data = JSON.parse(this.responseText);
          console.log(data)
          console.log(parseFloat(data.rows[0].elements[0].distance.text))
          distancia.push(parseFloat(data.rows[0].elements[0].distance.text))
          var t = document.getElementById('t')
          var strong_t = document.createElement('strong')
          t.textContent = 'Tempo: ' + data.rows[0].elements[0].duration.text
          var d = document.getElementById('d')
          var strong_d = document.createElement('strong')
          d.textContent = 'Distancia: ' + data.rows[0].elements[0].distance.text
          var local_a = document.getElementById('local_a')
          local_a.textContent = 'Local A: ' + data.origin_addresses[0]
          var local_b = document.getElementById('local_b')
          local_b.textContent = 'Local B: ' + data.destination_addresses[0]

        }
      };
  
      dirdisplay.setMap(mapa) //usar para setar o mapa
      
      calculateRoute(dirservice, dirdisplay, partida, destino); //usar em uniao com o de cima para plotar rota
      //"https://maps.googleapis.com/maps/api/distancematrix/json?origins=-23.5782479,-46.6425898&destinations=-23.6229423,-46.630948&departure_time=now&key=AIzaSyBdJ_Kts10iRTTj6tZh8pv0mjB2vp6Mcm4" url exemplo
      xhr.open("GET" , "http://10.148.3.130:8000/user/api/coordenadas");
      xhr.send();
    }
    
    function apagaMapa (d) {
        d.set('directions', null)
        console.log('APAGUEI SA PORRA')
      }
    function distanciaETempoDaRota(ori, dest) {
      var service = new google.maps.DistanceMatrixService();
      service.getDistanceMatrix(
        {
          origins: [ori],
          destinations: [dest],
          travelMode: 'DRIVING',
        }, function(response, status) {
          console.log(response)
          let di = response.rows[0].elements[0].distance.text
          let di_replace = di.replace(',', '.')
          console.log(di_replace)
          let te = response.rows[0].elements[0].duration.text
          distancia.push(parseFloat(di_replace))
          tempo.push(te)
          end_cliente = response.originAddresses[0]
          end_elec = response.destinationAddresses[0]
        });
    }
    function distanciaETempoDaRotaFormulario(parti, desti) {
      var service = new google.maps.DistanceMatrixService();
      service.getDistanceMatrix(
        {
          origins: [parti],
          destinations: [desti],
          travelMode: 'DRIVING',
        }, function(response, status) {
          console.log('RESPOSTA', response)
          let di = response.rows[0].elements[0].distance.text
          let di_replace = di.replace(',', '.')
          let te = response.rows[0].elements[0].duration.text
          var local_a = document.getElementById('local_a')
          local_a.textContent = 'Local de partida: ' + response.originAddresses[0]
          local_a.style = 'color: black'
          var local_b = document.getElementById('local_b')
          local_b.textContent = 'Local de destino: ' + response.destinationAddresses[0]
          local_b.style = 'color: black'
          var km = document.getElementById('d')
          km.textContent = 'Distancia: ' + di_replace
          var hrs = document.getElementById('t')
          hrs.textContent = 'Tempo: ' + te
          var info = document.getElementsByClassName('info')
          for (var p = 0; p < info.length; p++) {
            info[p].style = 'display : block'
          }
          
        });
    }
    function mostrarMapaCompletoComMenorDistanciaEntreClienteEEletricista () {
      setTimeout(function() {
        for (var m = 0; m < eletricistas.length; m++) {
          distanciaETempoDaRota(eu, eletricistas[m])
        }
        setTimeout(calculaMenorESetaRota, 500)
        //jsonRequest({lat:eu.lat(), lng:eu.lng()}, {lat:elec1.lat(), lng:elec1.lng()}, map)
      }, 500)
    }
    function calculaMenorESetaRota() {
      var menor = distancia[0]
      var k;
      var indice
      for (k = 1; k < distancia.length; k++) {
        if(distancia[k] < menor) {
          menor = distancia[k];
          indice = k
        }
      }
      console.log("o menor é: ", menor)
      console.log("com indice: ", indice)
      console.log("tamanho: ", distancia.length)
      dirdisplay.setMap(map)
      calculateRoute(dirservice, dirdisplay, eu, eletricistas[indice])
      escreverDeltaTeDeltaD(menor, indice)
    }
    function escreverDeltaTeDeltaD(menordistancia, index, cliente, eletricista){
      var t = document.getElementById('t')
      var strong_t = document.createElement('strong')
      t.textContent = 'Tempo: ' + tempo[index]
      var d = document.getElementById('d')
      var strong_d = document.createElement('strong')
      d.textContent = 'Distancia: ' + menordistancia + ' km'
      var local_a = document.getElementById('local_a')
      local_a.textContent = 'Você está em: ' + end_cliente
      var local_b = document.getElementById('local_b')
      local_b.textContent = 'O Eletricista está em: ' + end_elec
      var info = document.getElementsByClassName('info')
      for (var l = 0; l < info.length; l++) {
        info[l].style = 'display : block'
      }
      
    }
    function setaRotaDoFormulario(partida, destino) {
      dirdisplay.setMap(map)
      calculateRoute(dirservice, dirdisplay, partida, destino)
      distanciaETempoDaRotaFormulario(partida, destino)
    }
  function patchLatLng() {
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    fetch('http://localhost:8000/api/eletricistas/', {
        method: 'post',
        headers: {
          'Accept': 'application/json, text/plain, */*',
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
              telefone: "0192",
              CEP: "000",
              CPF: "00101",
              endereco: "123",
              genero: "Feminino",
              tipo: "Eletricista",
              status: "Ativo",
              bloqueado: "False",
              usuario: {
                  first_name: "doria",
                  email: "joaodoria@hotmail.com",
                  password: "1234567",
                  username: "doriaeoq",
                  is_active: true
              }
          })
      }).then((res) => console.log(res))
  }
  //patchLatLng()
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdJ_Kts10iRTTj6tZh8pv0mjB2vp6Mcm4&callback=initMap"
    async defer></script>
          </div>
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <!-- plugins:js -->
  <script src="{% static 'radiant/jquery/vendors/js/vendor.bundle.base.js' %}"></script>
  <script src="{% static 'radiant/jquery/vendors/js/vendor.bundle.addons.js' %}"></script>
  <!-- endinject -->
  <!-- Plugin js for this page-->
  <!-- End plugin js for this page-->
  <!-- inject:js -->
  <script src="{% static 'radiant/jquery/js/off-canvas.js' %}"></script>
  <script src="{% static 'radiant/jquery/js/hoverable-collapse.js' %}"></script>
  <script src="{% static 'radiant/jquery/js/misc.js' %}"></script>
  <script src="{% static 'radiant/jquery/js/settings.js' %}"></script>
  <script src="{% static 'radiant/jquery/js/todolist.js' %}"></script>
  <!-- endinject -->
  <!-- Custom js for this page-->
  <script src="{% static 'radiant/jquery/js/dashboard.js' %}"></script>
  <script src="{% static 'radiant/jquery/js/horizontal-menu.js' %}"></script>
  <!-- End custom js for this page-->
</body>

</html>
