{% extends 'base_cliente.html' %}
{% load staticfiles %}
{% block content %}
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<style type="text/css">
		#map {
			width: 1200px;
			height: 430px;
		}
		.row {
			margin-top:-12.5px;
		}
		h4 {
			margin: 15px;
		}
		.info {
			display: none;
		}
	</style>
	<div class="row">
		<div id="map"></div>
	</div>
	<input type="text" name="enderecoA" placeholder="Digite o local da partida" style="margin: 15px" id="A" class="form-control">
	<input type="text" name="enderecoB" placeholder="Digite o local de destino" style="margin: 15px; float: center; margin-left: 15px" id="B" class="form-control">
	<button id="botao" class="btn btn-success" style="margin-left: 46%">Enviar</button>
	<h4 id="local_a" class="info" >Local A: </h4>
	<h4 id="local_b" class="info" >Local B: </h4>
	<h4 id="t" class="info" >Tempo de chegada: </h4>
	<h4 id="d" class="info" >Distancia total: </h4>
	<button id="solicitar" class="btn btn-warning" style="margin-left: 43%; margin-top: 10px">Soliciar Serviço</button>
	<script>
		//geocoding transforma adress em latlng
		alert('Temos 1 cliente na minha casa(Rua Cubatao) e 5 eletricistas(Na faria lima, na poli, na paulista, num extra do lado de casa e num sesc da vila mariana) todos estáticos, depois é só trocar essas dados com dados reais(latitude e longitude, armazenados no db)')
		var distancia = []
		var tempo = []
		var eletricistas = []
		var end_cliente
		var end_elec
		var map
		var dirdisplay
		var dirservice
		var elec1
		var elec2
		var elec3
		var elec4
		var elec5
		var eu
		var botao = document.getElementById('botao')
		botao.addEventListener('click', () => {
			var partida = document.getElementById('A').value
			var destino = document.getElementById('B').value
			//jsonRequest(partida, destino, map)
			//distanciaETempoDaRota(partida, destino)
			setaRotaDoFormulario(partida, destino)
		})
		var solicitar_servico = document.getElementById('solicitar')
		solicitar_servico.addEventListener('click', () => {
			mostrarMapaCompletoComMenorDistanciaEntreClienteEEletricista()
		})
		function initMap() {
			var options = {
				zoom: 15,
				center: {lat:-23.5782479, lng:-46.6425898}
			}

			map = new google.maps.Map(document.getElementById('map'), options);
			addMarker(options.center, map);

			eu = new google.maps.LatLng(-23.5782479, -46.6425898)	//cliente em questao(no caso eu, rola)
			elec1 = new google.maps.LatLng(-23.5773671, -46.6868916) //faria lima
			elec2 = new google.maps.LatLng(-23.5631043, -46.6543825) //av paulista
			elec3 = new google.maps.LatLng(-23.5571644, -46.730234) //poli
			elec4 = new google.maps.LatLng(-23.5822135, -46.6441941) //sesc vila mariana
			elec5 = new google.maps.LatLng(-23.5799952, -46.6403997) //extra vila mariana
			addMarker(elec1, map)
			addMarker(elec2, map)
			addMarker(elec3, map)
			addMarker(elec4, map)
			addMarker(elec5, map)

			dirdisplay = new google.maps.DirectionsRenderer();
			dirservice = new google.maps.DirectionsService();
	
			eletricistas.push(elec1)
			eletricistas.push(elec2)
			eletricistas.push(elec3)
			eletricistas.push(elec4)
			eletricistas.push(elec5)
		}

		function addMarker(position, map) {
			var marker = new google.maps.Marker({position: position, map:map});
		}
		
		function calculateRoute(dir, dis, ori, dest) {
			//origins=-23.5782479,-46.6425898&destinations=-23.6229423,-46.6360948
			apagaMapa(dis)

			var request = {
				//origin: new google.maps.LatLng(-23.5782479, -46.6425898),
				origin: ori,
				//destination: new google.maps.LatLng(-23.6229423, -46.630948),
				destination: dest,
				travelMode:'DRIVING',
			};
			//var dir = new google.maps.DirectionsService();
			dir.route(request, function(response, status) {
				console.log(status);
				if(status == 'OK'){
					//var dis = new google.maps.DirectionsRenderer();
					console.log(response);
					dis.setDirections(response);
				}
			});
		}


		
		function jsonRequest(partida, destino, mapa) {
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {

					var data = JSON.parse(this.responseText);
					console.log(data)
					console.log(parseFloat(data.rows[0].elements[0].distance.text))
					distancia.push(parseFloat(data.rows[0].elements[0].distance.text))
					var t = document.getElementById('t')
					var strong_t = document.createElement('strong')
					t.textContent = 'Tempo: ' + data.rows[0].elements[0].duration.text
					var d = document.getElementById('d')
					var strong_d = document.createElement('strong')
					d.textContent = 'Distancia: ' + data.rows[0].elements[0].distance.text
					var local_a = document.getElementById('local_a')
					local_a.textContent = 'Local A: ' + data.origin_addresses[0]
					var local_b = document.getElementById('local_b')
					local_b.textContent = 'Local B: ' + data.destination_addresses[0]

				}
			};
	
			dirdisplay.setMap(mapa) //usar para setar o mapa
			
			calculateRoute(dirservice, dirdisplay, partida, destino); //usar em uniao com o de cima para plotar rota
			//"https://maps.googleapis.com/maps/api/distancematrix/json?origins=-23.5782479,-46.6425898&destinations=-23.6229423,-46.630948&departure_time=now&key=AIzaSyBdJ_Kts10iRTTj6tZh8pv0mjB2vp6Mcm4" url exemplo
			xhr.open("GET" , "https://maps.googleapis.com/maps/api/distancematrix/json?origins=" + partida + "&destinations=" + destino + "&departure_time=now&key=AIzaSyBdJ_Kts10iRTTj6tZh8pv0mjB2vp6Mcm4", true);
			xhr.send();
		}
		
		function apagaMapa (d) {
				d.set('directions', null)
				console.log('APAGUEI SA PORRA')
			}
		function distanciaETempoDaRota(ori, dest) {
			var service = new google.maps.DistanceMatrixService();
			service.getDistanceMatrix(
				{
					origins: [ori],
					destinations: [dest],
					travelMode: 'DRIVING',
				}, function(response, status) {
					console.log(response)
					let di = response.rows[0].elements[0].distance.text
					let di_replace = di.replace(',', '.')
					console.log(di_replace)
					let te = response.rows[0].elements[0].duration.text
					distancia.push(parseFloat(di_replace))
					tempo.push(te)
					end_cliente = response.originAddresses[0]
					end_elec = response.destinationAddresses[0]
				});
		}
		function distanciaETempoDaRotaFormulario(parti, desti) {
			var service = new google.maps.DistanceMatrixService();
			service.getDistanceMatrix(
				{
					origins: [parti],
					destinations: [desti],
					travelMode: 'DRIVING',
				}, function(response, status) {
					console.log('RESPOSTA', response)
					let di = response.rows[0].elements[0].distance.text
					let di_replace = di.replace(',', '.')
					let te = response.rows[0].elements[0].duration.text
					var local_a = document.getElementById('local_a')
					local_a.textContent = 'Local de partida: ' + response.originAddresses[0]
					local_a.style = 'color: black'
					var local_b = document.getElementById('local_b')
					local_b.textContent = 'Local de destino: ' + response.destinationAddresses[0]
					local_b.style = 'color: black'
					var km = document.getElementById('d')
					km.textContent = 'Distancia: ' + di_replace
					var hrs = document.getElementById('t')
					hrs.textContent = 'Tempo: ' + te
					var info = document.getElementsByClassName('info')
					for (var p = 0; p < info.length; p++) {
						info[p].style = 'display : block'
					}
					
				});
		}
		function mostrarMapaCompletoComMenorDistanciaEntreClienteEEletricista () {
			setTimeout(function() {
				for (var m = 0; m < eletricistas.length; m++) {
					distanciaETempoDaRota(eu, eletricistas[m])
				}
				setTimeout(calculaMenorESetaRota, 500)
				//jsonRequest({lat:eu.lat(), lng:eu.lng()}, {lat:elec1.lat(), lng:elec1.lng()}, map)
			}, 500)
		}
		function calculaMenorESetaRota() {
			var menor = distancia[0]
			var k;
			var indice
			for (k = 1; k < distancia.length; k++) {
				if(distancia[k] < menor) {
					menor = distancia[k];
					indice = k
				}
			}
			console.log("o menor é: ", menor)
			console.log("com indice: ", indice)
			console.log("tamanho: ", distancia.length)
			dirdisplay.setMap(map)
			calculateRoute(dirservice, dirdisplay, eu, eletricistas[indice])
			escreverDeltaTeDeltaD(menor, indice)
		}
		function escreverDeltaTeDeltaD(menordistancia, index, cliente, eletricista){
			var t = document.getElementById('t')
			var strong_t = document.createElement('strong')
			t.textContent = 'Tempo: ' + tempo[index]
			var d = document.getElementById('d')
			var strong_d = document.createElement('strong')
			d.textContent = 'Distancia: ' + menordistancia + ' km'
			var local_a = document.getElementById('local_a')
			local_a.textContent = 'Você está em: ' + end_cliente
			var local_b = document.getElementById('local_b')
			local_b.textContent = 'O Eletricista está em: ' + end_elec
			var info = document.getElementsByClassName('info')
			for (var l = 0; l < info.length; l++) {
				info[l].style = 'display : block'
			}
			
		}
		function setaRotaDoFormulario(partida, destino) {
			dirdisplay.setMap(map)
			calculateRoute(dirservice, dirdisplay, partida, destino)
			distanciaETempoDaRotaFormulario(partida, destino)
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdJ_Kts10iRTTj6tZh8pv0mjB2vp6Mcm4&callback=initMap"
    async defer></script>
{% endblock %}